<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dopo ‚Äî Your best finds, all in one place</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #14141f;
    --surface-hover: #1c1c2e;
    --border: #2a2a3d;
    --text: #e8e8ef;
    --text-muted: #8888a0;
    --text-dim: #5a5a72;
    --accent: #ff6b35;
    --accent-glow: rgba(255, 107, 53, 0.15);
    --youtube: #ff0033;
    --instagram: #e1306c;
    --tiktok: #00f2ea;
    --twitter: #1d9bf0;
    --facebook: #1877f2;
    --success: #34d399;
    --error: #f87171;
    --radius: 12px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }
  .app { max-width: 900px; margin: 0 auto; padding: 24px 20px 100px; }
  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 0 32px; border-bottom: 1px solid var(--border); margin-bottom: 32px;
  }
  .logo {
    font-family: 'Space Mono', monospace; font-size: 28px; font-weight: 700;
    letter-spacing: -1px;
    background: linear-gradient(135deg, var(--accent), #ff9a6c);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .logo-sub { font-size: 12px; color: var(--text-dim); font-family: 'Space Mono', monospace; letter-spacing: 2px; text-transform: uppercase; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  .user-badge { font-size: 12px; color: var(--text-muted); background: var(--surface); padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); }
  .sign-out-btn {
    font-size: 12px; color: var(--text-dim); background: none; border: 1px solid var(--border);
    padding: 6px 14px; border-radius: 20px; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .sign-out-btn:hover { color: var(--error); border-color: var(--error); background: rgba(248,113,113,0.08); }
  .ingest-section { margin-bottom: 32px; }
  .ingest-bar { display: flex; gap: 10px; align-items: stretch; }
  .ingest-input {
    flex: 1; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px 18px; color: var(--text); font-size: 15px; font-family: 'DM Sans', sans-serif;
    outline: none; transition: border-color 0.2s, box-shadow 0.2s;
  }
  .ingest-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  .ingest-input::placeholder { color: var(--text-dim); }
  .ingest-btn {
    background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
    padding: 14px 24px; font-size: 15px; font-weight: 600; font-family: 'DM Sans', sans-serif;
    cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 8px;
  }
  .ingest-btn:hover:not(:disabled) { background: #ff8555; transform: translateY(-1px); box-shadow: 0 4px 16px var(--accent-glow); }
  .ingest-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .ingest-status { margin-top: 10px; font-size: 13px; padding: 10px 14px; border-radius: 8px; display: none; }
  .ingest-status.show { display: block; }
  .ingest-status.success { background: rgba(52, 211, 153, 0.1); color: var(--success); border: 1px solid rgba(52, 211, 153, 0.2); }
  .ingest-status.error { background: rgba(248, 113, 113, 0.1); color: var(--error); border: 1px solid rgba(248, 113, 113, 0.2); }
  .ingest-status.loading { background: rgba(255, 107, 53, 0.1); color: var(--accent); border: 1px solid rgba(255, 107, 53, 0.2); }
  .toolbar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
  .search-input {
    flex: 1; min-width: 200px; background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 10px 16px 10px 38px; color: var(--text); font-size: 14px;
    font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235a5a72' viewBox='0 0 24 24'%3E%3Cpath d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' stroke='%235a5a72' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: 12px center;
  }
  .search-input:focus { border-color: var(--accent); }
  .filter-btn {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 14px; color: var(--text-muted); font-size: 13px; font-family: 'DM Sans', sans-serif;
    cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px;
  }
  .filter-btn:hover { background: var(--surface-hover); color: var(--text); }
  .filter-btn.active { background: var(--accent-glow); color: var(--accent); border-color: var(--accent); }
  .filter-btn svg { width: 14px; height: 14px; flex-shrink: 0; }
  .stats-bar { font-size: 12px; color: var(--text-dim); margin-bottom: 16px; font-family: 'Space Mono', monospace; }
  .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; transition: all 0.2s; cursor: default; position: relative;
  }
  .card:hover { border-color: #3a3a4d; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .card-thumb-wrap { position: relative; width: 100%; height: 160px; overflow: hidden; }
  .card-thumb-wrap .card-thumb-placeholder { position: absolute; inset: 0; }
  .card-thumb-wrap .card-thumb { position: relative; z-index: 1; }
  .card-thumb { width: 100%; height: 160px; object-fit: cover; display: block; background: var(--surface-hover); }
  .card-thumb-placeholder { width: 100%; height: 160px; display: flex; align-items: center; justify-content: center; background: var(--surface-hover); }
  .card-thumb-placeholder svg { width: 48px; height: 48px; opacity: 0.6; }
  .card-thumb-placeholder.youtube { background: linear-gradient(135deg, #1a0005 0%, #330011 50%, #1a0005 100%); }
  .card-thumb-placeholder.youtube svg { opacity: 0.7; }
  .card-thumb-placeholder.instagram { background: linear-gradient(135deg, #1a0a10 0%, #2d0e1e 50%, #1a0a18 100%); }
  .card-thumb-placeholder.instagram svg { opacity: 0.7; }
  .card-thumb-placeholder.tiktok { background: linear-gradient(135deg, #0a1a1a 0%, #0d2626 50%, #0a1a1a 100%); }
  .card-thumb-placeholder.tiktok svg { opacity: 0.7; }
  .card-thumb-placeholder.twitter { background: linear-gradient(135deg, #0a1520 0%, #0d1f30 50%, #0a1520 100%); }
  .card-thumb-placeholder.twitter svg { opacity: 0.7; }
  .card-thumb-placeholder.facebook { background: linear-gradient(135deg, #0a1020 0%, #0d1830 50%, #0a1020 100%); }
  .card-thumb-placeholder.facebook svg { opacity: 0.7; }
  .card-thumb-placeholder.other { background: linear-gradient(135deg, #12121e 0%, #1a1a2e 50%, #12121e 100%); }
  .card-thumb-placeholder.other svg { opacity: 0.5; }
  .card-body { padding: 14px 16px 16px; }
  .card-platform {
    display: inline-flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; padding: 3px 8px; border-radius: 4px;
  }
  .card-platform svg { width: 14px; height: 14px; flex-shrink: 0; }
  .card-platform.youtube { color: var(--youtube); background: rgba(255,0,51,0.1); }
  .card-platform.instagram { color: var(--instagram); background: rgba(225,48,108,0.1); }
  .card-platform.tiktok { color: var(--tiktok); background: rgba(0,242,234,0.1); }
  .card-platform.twitter { color: var(--twitter); background: rgba(29,155,240,0.1); }
  .card-platform.facebook { color: var(--facebook); background: rgba(24,119,242,0.1); }
  .card-platform.other { color: var(--text-muted); background: rgba(136,136,160,0.1); }
  .card-content-type { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-left: 6px; }
  .card-title { font-size: 14px; font-weight: 500; line-height: 1.4; color: var(--text); margin-bottom: 6px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  .card-creator { font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
  .card-creator-handle { color: var(--accent); font-weight: 500; font-size: 12px; }
  .card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
  .card-tag { font-size: 11px; color: var(--text-dim); background: rgba(136,136,160,0.1); padding: 2px 8px; border-radius: 4px; }
  .card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
  .card-date { font-size: 11px; color: var(--text-dim); font-family: 'Space Mono', monospace; }
  .card-actions { display: flex; gap: 6px; align-items: center; }
  .card-action { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 4px 6px; border-radius: 4px; font-size: 14px; transition: all 0.15s; }
  .card-action:hover { color: var(--text); background: var(--surface-hover); }
  .card-action.favorited { color: var(--accent); }
  .card-link { font-size: 11px; color: var(--accent); text-decoration: none; font-weight: 500; transition: opacity 0.15s; }
  .card-link:hover { opacity: 0.8; }
  .card-enrichment { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; border-radius: 50%; }
  .card-enrichment.complete { background: var(--success); }
  .card-enrichment.pending { background: #fbbf24; }
  .card-enrichment.failed { background: var(--error); }
  .card-platform-overlay {
    position: absolute; top: 8px; left: 8px; z-index: 5;
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
  }
  .card-platform-overlay svg { width: 28px; height: 28px; }
  .search-hint {
    display: flex; align-items: center; gap: 8px; padding: 8px 14px; margin-bottom: 12px;
    background: var(--accent-glow); border: 1px solid rgba(255,107,53,0.2); border-radius: 8px;
    font-size: 12px; color: var(--accent);
  }
  .search-hint-tag {
    background: rgba(255,107,53,0.15); padding: 2px 8px; border-radius: 4px; font-weight: 500;
  }
  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
  .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
  .empty-state h3 { color: var(--text-muted); font-size: 18px; margin-bottom: 8px; }
  .empty-state p { font-size: 14px; max-width: 400px; margin: 0 auto; line-height: 1.6; }
  .auth-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px); }
  .auth-modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 40px; width: 100%; max-width: 400px; text-align: center; }
  .auth-modal h2 { font-family: 'Space Mono', monospace; font-size: 24px; margin-bottom: 8px; background: linear-gradient(135deg, var(--accent), #ff9a6c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .auth-modal p { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }
  .auth-field { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif; outline: none; margin-bottom: 12px; transition: border-color 0.2s; }
  .auth-field:focus { border-color: var(--accent); }
  .auth-submit { width: 100%; background: var(--accent); color: #fff; border: none; border-radius: 8px; padding: 12px; font-size: 15px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: background 0.2s; margin-top: 4px; }
  .auth-submit:hover { background: #ff8555; }
  .auth-toggle { margin-top: 16px; font-size: 13px; color: var(--text-muted); }
  .auth-toggle a { color: var(--accent); cursor: pointer; text-decoration: none; }
  .auth-error { color: var(--error); font-size: 13px; margin-top: 10px; display: none; }
  .auth-error.show { display: block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { width: 18px; height: 18px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
  /* Collections styles */
  .collections-bar {
    display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
    padding: 12px 0; border-bottom: 1px solid var(--border);
  }
  .collections-bar-label { font-size: 11px; color: var(--text-dim); font-family: 'Space Mono', monospace; text-transform: uppercase; letter-spacing: 1px; margin-right: 4px; }
  .coll-chip {
    display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 20px;
    font-size: 13px; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.15s;
    background: var(--surface); border: 1px solid var(--border); color: var(--text-muted); white-space: nowrap;
  }
  .coll-chip:hover { background: var(--surface-hover); color: var(--text); }
  .coll-chip.active { background: var(--accent-glow); color: var(--accent); border-color: var(--accent); }
  .coll-chip .coll-count { font-size: 11px; opacity: 0.6; font-family: 'Space Mono', monospace; }
  .coll-chip-add {
    display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 20px;
    font-size: 13px; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.15s;
    background: none; border: 1px dashed var(--border); color: var(--text-dim);
  }
  .coll-chip-add:hover { border-color: var(--accent); color: var(--accent); }
  /* Collection modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex;
    align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(6px);
  }
  .modal-overlay.hidden { display: none; }
  .modal-box {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 28px 32px; width: 100%; max-width: 420px;
  }
  .modal-box h3 { font-size: 18px; margin-bottom: 16px; color: var(--text); }
  .modal-field {
    width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 14px; color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif;
    outline: none; margin-bottom: 12px; transition: border-color 0.2s;
  }
  .modal-field:focus { border-color: var(--accent); }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }
  .modal-btn {
    padding: 8px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
    font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.15s;
  }
  .modal-btn-primary { background: var(--accent); color: #fff; border: none; }
  .modal-btn-primary:hover { background: #ff8555; }
  .modal-btn-secondary { background: none; color: var(--text-muted); border: 1px solid var(--border); }
  .modal-btn-secondary:hover { background: var(--surface-hover); }
  /* Add-to-collection dropdown on cards */
  .card-coll-btn { position: relative; }
  .card-coll-dropdown {
    position: absolute; bottom: 100%; right: 0; margin-bottom: 6px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 10px; padding: 8px 0; min-width: 200px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 50; display: none;
  }
  .card-coll-dropdown.show { display: block; }
  .card-coll-dropdown-item {
    display: flex; align-items: center; gap: 8px; padding: 8px 14px; font-size: 13px;
    color: var(--text-muted); cursor: pointer; transition: all 0.1s; border: none;
    background: none; width: 100%; text-align: left; font-family: 'DM Sans', sans-serif;
  }
  .card-coll-dropdown-item:hover { background: var(--surface-hover); color: var(--text); }
  .card-coll-dropdown-item .coll-check { width: 16px; text-align: center; color: var(--accent); }
  .coll-manage-bar { display: flex; align-items: center; gap: 6px; margin-left: auto; }
  .coll-manage-btn {
    background: none; border: none; color: var(--text-dim); font-size: 12px; cursor: pointer;
    font-family: 'DM Sans', sans-serif; padding: 4px 8px; border-radius: 4px; transition: all 0.15s;
  }
  .coll-manage-btn:hover { color: var(--error); background: rgba(248,113,113,0.08); }
  .coll-manage-btn.share-btn:hover { color: var(--accent); background: var(--accent-glow); }
  /* Share modal styles */
  .share-section { margin-bottom: 20px; }
  .share-section-title { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
  .share-toggle-row {
    display: flex; align-items: center; justify-content: space-between; padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .share-toggle-label { font-size: 14px; color: var(--text); }
  .share-toggle-desc { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
  .toggle-switch {
    position: relative; width: 44px; height: 24px; background: var(--border); border-radius: 12px;
    cursor: pointer; transition: background 0.2s; border: none; padding: 0;
  }
  .toggle-switch.on { background: var(--accent); }
  .toggle-switch::after {
    content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
    background: #fff; border-radius: 50%; transition: transform 0.2s;
  }
  .toggle-switch.on::after { transform: translateX(20px); }
  .share-link-row {
    display: flex; gap: 8px; align-items: center; margin-top: 12px; padding: 10px 14px;
    background: var(--bg); border-radius: 8px; border: 1px solid var(--border);
  }
  .share-link-url {
    flex: 1; font-size: 12px; color: var(--text-muted); font-family: 'Space Mono', monospace;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .share-link-copy {
    background: var(--accent); color: #fff; border: none; border-radius: 6px; padding: 6px 14px;
    font-size: 12px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: all 0.15s; white-space: nowrap;
  }
  .share-link-copy:hover { background: #ff8555; }
  .collab-list { margin-top: 8px; }
  .collab-row {
    display: flex; align-items: center; justify-content: space-between; padding: 8px 0;
    border-bottom: 1px solid rgba(42,42,61,0.5); font-size: 13px;
  }
  .collab-email { color: var(--text); }
  .collab-role { color: var(--text-dim); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
  .collab-remove { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 4px; }
  .collab-remove:hover { color: var(--error); background: rgba(248,113,113,0.1); }
  .collab-invite-row { display: flex; gap: 8px; margin-top: 12px; }
  .collab-invite-input {
    flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 12px; color: var(--text); font-size: 13px; font-family: 'DM Sans', sans-serif; outline: none;
  }
  .collab-invite-input:focus { border-color: var(--accent); }
  .collab-role-select {
    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 10px; color: var(--text); font-size: 13px; font-family: 'DM Sans', sans-serif;
    outline: none; cursor: pointer; min-width: 100px; appearance: auto;
  }
  .collab-role-select:focus { border-color: var(--accent); }
  .collab-invite-btn {
    background: var(--surface); border: 1px solid var(--accent); color: var(--accent); border-radius: 8px;
    padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }
  .collab-invite-btn:hover { background: var(--accent-glow); }
  .collab-status { font-size: 12px; margin-top: 6px; min-height: 18px; }
  .collab-role-badge {
    font-size: 10px; padding: 2px 8px; border-radius: 10px; text-transform: uppercase;
    letter-spacing: 0.5px; font-weight: 600;
  }
  .collab-role-badge.editor { color: var(--accent); background: var(--accent-glow); }
  .collab-role-badge.viewer { color: var(--text-dim); background: rgba(90,90,114,0.15); }
  .collab-role-change {
    background: none; border: 1px solid var(--border); color: var(--text-dim); cursor: pointer;
    font-size: 10px; padding: 2px 8px; border-radius: 10px; font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }
  .collab-role-change:hover { border-color: var(--accent); color: var(--accent); }
  .viewer-notice {
    background: rgba(90,90,114,0.1); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 14px; font-size: 13px; color: var(--text-muted); margin-bottom: 16px;
    display: flex; align-items: center; gap: 8px;
  }
  /* Delete confirmation modal */
  .confirm-delete-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex;
    align-items: center; justify-content: center; z-index: 300; backdrop-filter: blur(6px);
  }
  .confirm-delete-box {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 28px 32px; width: 100%; max-width: 380px; text-align: center;
  }
  .confirm-delete-box h3 { font-size: 18px; margin-bottom: 8px; }
  .confirm-delete-box p { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
  .confirm-delete-box .modal-actions { justify-content: center; }
  .modal-btn-danger { background: var(--error); color: #fff; border: none; }
  .modal-btn-danger:hover { background: #ef4444; }
  .card-action.delete-btn:hover { color: var(--error); }
  /* Toast notifications */
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 400; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 20px; font-size: 13px; color: var(--text); box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    display: flex; align-items: center; gap: 10px; animation: toastIn 0.3s ease-out;
    max-width: 360px;
  }
  .toast.success { border-color: rgba(52,211,153,0.3); }
  .toast.success .toast-icon { color: var(--success); }
  .toast.error { border-color: rgba(248,113,113,0.3); }
  .toast.error .toast-icon { color: var(--error); }
  .toast-icon { font-size: 16px; flex-shrink: 0; }
  @keyframes toastIn { from { opacity: 0; transform: translateY(12px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
  @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-8px); } }
  /* Loading skeleton */
  .skeleton-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
  .skeleton-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden;
  }
  .skeleton-thumb { width: 100%; height: 160px; background: var(--surface-hover); }
  .skeleton-body { padding: 14px 16px 16px; }
  .skeleton-line {
    height: 12px; border-radius: 6px; background: linear-gradient(90deg, var(--surface-hover) 25%, #252538 50%, var(--surface-hover) 75%);
    background-size: 200% 100%; animation: shimmer 1.5s infinite; margin-bottom: 10px;
  }
  .skeleton-line.short { width: 40%; }
  .skeleton-line.medium { width: 70%; }
  .skeleton-line.long { width: 100%; }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  @media (max-width: 600px) {
    .cards-grid, .skeleton-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    /* Square tile cards on mobile */
    .card { position: relative; aspect-ratio: 1; overflow: hidden; }
    .card-thumb-wrap { position: absolute; inset: 0; height: 100%; width: 100%; }
    .card-thumb-wrap .card-thumb-placeholder { height: 100%; }
    .card-thumb { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .card-thumb-placeholder { height: 100%; }
    .card-platform-overlay { z-index: 3; }
    /* Overlay title at bottom with gradient */
    .card-body {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 2;
      background: linear-gradient(transparent, rgba(0,0,0,0.85));
      padding: 24px 10px 10px;
    }
    .card-body > div:first-child { display: none; } /* hide platform badge row */
    .card-title { font-size: 12px; -webkit-line-clamp: 2; color: #fff; margin-bottom: 0; line-height: 1.3; }
    .card-creator { display: none; }
    .card-tags { display: none; }
    .card-meta { display: none; }
    .card-enrichment { z-index: 4; }
    .card:hover { transform: none; box-shadow: none; }
    /* Square skeleton cards on mobile */
    .skeleton-card { aspect-ratio: 1; }
    .skeleton-thumb { height: 100%; }
    .skeleton-body { display: none; }
    .ingest-bar { flex-direction: column; }
    .toolbar { flex-direction: column; }
    .search-input { min-width: 100%; }
    .collections-bar { gap: 6px; }
    .coll-chip { font-size: 12px; padding: 5px 10px; }
    .header { flex-direction: column; gap: 12px; text-align: center; }
    .header-right { justify-content: center; }
    .collab-invite-row { flex-direction: column; }
    .collab-role-select { min-width: auto; }
    .modal-box { margin: 16px; padding: 20px 24px; }
    .toast-container { left: 16px; right: 16px; bottom: 16px; }
    .toast { max-width: 100%; }
    .detail-modal-content { border-radius: 16px 16px 0 0; max-height: 90vh; }
  }
  /* Detail modal (slide-up) */
  .detail-modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex;
    align-items: flex-end; justify-content: center; z-index: 250; backdrop-filter: blur(6px);
    animation: fadeIn 0.2s ease-out;
  }
  .detail-modal-content {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px 16px 0 0;
    width: 100%; max-width: 600px; max-height: 85vh; overflow-y: auto;
    animation: slideUp 0.3s ease-out;
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .detail-modal-header {
    display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;
    border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--surface); z-index: 1;
  }
  .detail-modal-header h3 { font-size: 16px; color: var(--text); }
  .detail-modal-close {
    background: none; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer;
    padding: 4px 8px; border-radius: 6px; transition: all 0.15s;
  }
  .detail-modal-close:hover { background: var(--surface-hover); color: var(--text); }
  .detail-modal-body { padding: 20px; }
  .detail-thumb { width: 100%; max-height: 240px; object-fit: cover; border-radius: 10px; margin-bottom: 16px; }
  .detail-field-group { margin-bottom: 16px; }
  .detail-field-label { font-size: 11px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .detail-field-input {
    width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 14px; color: var(--text); font-size: 14px; font-family: 'DM Sans', sans-serif;
    outline: none; transition: border-color 0.2s;
  }
  .detail-field-input:focus { border-color: var(--accent); }
  .detail-tags-input-wrap { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
  .detail-tag-chip {
    display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 6px;
    font-size: 12px; background: rgba(136,136,160,0.1); color: var(--text-muted);
  }
  .detail-tag-remove { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 14px; padding: 0 2px; }
  .detail-tag-remove:hover { color: var(--error); }
  .detail-tag-add-input {
    background: none; border: none; color: var(--text); font-size: 12px; outline: none;
    font-family: 'DM Sans', sans-serif; min-width: 80px; flex: 1;
  }
  .detail-tag-add-input::placeholder { color: var(--text-dim); }
  .detail-collections-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .detail-coll-chip {
    display: inline-flex; align-items: center; gap: 4px; padding: 5px 10px; border-radius: 8px;
    font-size: 12px; background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(255,107,53,0.2);
    cursor: pointer; transition: all 0.15s;
  }
  .detail-coll-chip:hover { background: rgba(255,107,53,0.25); }
  .detail-coll-chip.inactive { background: var(--bg); color: var(--text-dim); border-color: var(--border); }
  .detail-coll-chip.inactive:hover { border-color: var(--accent); color: var(--accent); }
  .detail-save-btn {
    background: var(--accent); color: #fff; border: none; border-radius: 10px; padding: 10px 24px;
    font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: all 0.15s; margin-top: 8px;
  }
  .detail-save-btn:hover { background: #ff8555; }
  .detail-save-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .detail-info-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
  .detail-info-pill {
    font-size: 11px; padding: 4px 10px; border-radius: 6px; display: inline-flex; align-items: center; gap: 4px;
  }
  /* Favorites filter pill */
  .filter-btn.favorites-pill svg { width: 14px; height: 14px; }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  .card { animation: fadeInUp 0.3s ease-out both; }
  .card:nth-child(2) { animation-delay: 0.05s; }
  .card:nth-child(3) { animation-delay: 0.1s; }
  .card:nth-child(4) { animation-delay: 0.15s; }
  .card:nth-child(5) { animation-delay: 0.2s; }
  .card:nth-child(6) { animation-delay: 0.25s; }
  .bulk-section { margin-top: 12px; }
  .bulk-toggle { font-size: 13px; color: var(--text-dim); cursor: pointer; background: none; border: none; font-family: 'DM Sans', sans-serif; transition: color 0.15s; }
  .bulk-toggle:hover { color: var(--accent); }
  .bulk-area { display: none; margin-top: 10px; }
  .bulk-area.show { display: block; }
  .bulk-textarea { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 18px; color: var(--text); font-size: 13px; font-family: 'Space Mono', monospace; outline: none; resize: vertical; min-height: 120px; line-height: 1.8; transition: border-color 0.2s; }
  .bulk-textarea:focus { border-color: var(--accent); }
  .bulk-btn { margin-top: 10px; background: var(--surface); border: 1px solid var(--accent); color: var(--accent); border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 600; font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.2s; }
  .bulk-btn:hover { background: var(--accent-glow); }
  .bulk-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .bulk-progress { margin-top: 10px; font-size: 13px; color: var(--text-muted); font-family: 'Space Mono', monospace; }
</style>
</head>
<body>
<div id="authOverlay" class="auth-overlay">
  <div class="auth-modal">
    <h2>dopo</h2>
    <p>Your unified content library</p>
    <div id="authForm">
      <input id="authEmail" class="auth-field" type="email" placeholder="Email" />
      <input id="authPassword" class="auth-field" type="password" placeholder="Password" />
      <button id="authSubmit" class="auth-submit" onclick="handleAuth()">Sign In</button>
      <div id="authToggle" class="auth-toggle">Don't have an account? <a onclick="toggleAuthMode()">Sign up</a></div>
      <div id="authError" class="auth-error"></div>
    </div>
  </div>
</div>
<div class="app" id="app" style="display: none;">
  <header class="header">
    <div><div class="logo">dopo</div><div class="logo-sub">content library</div></div>
    <div class="header-right">
      <span id="userBadge" class="user-badge"></span>
      <button class="sign-out-btn" onclick="handleSignOut()">Sign Out</button>
    </div>
  </header>
  <div class="ingest-section">
    <div class="ingest-bar">
      <input id="ingestInput" class="ingest-input" type="url" placeholder="Paste a URL from YouTube, Instagram, TikTok, X, Facebook..." onkeydown="if(event.key==='Enter')handleIngest()" />
      <button id="ingestBtn" class="ingest-btn" onclick="handleIngest()"><span id="ingestBtnText">Save</span></button>
    </div>
    <div id="ingestStatus" class="ingest-status"></div>
    <div class="bulk-section">
      <button class="bulk-toggle" onclick="toggleBulk()">+ Bulk import (paste multiple URLs)</button>
      <div id="bulkArea" class="bulk-area">
        <textarea id="bulkTextarea" class="bulk-textarea" placeholder="Paste one URL per line..."></textarea>
        <button id="bulkBtn" class="bulk-btn" onclick="handleBulkIngest()">Import All</button>
        <div id="bulkProgress" class="bulk-progress"></div>
      </div>
    </div>
  </div>
  <div class="toolbar">
    <input id="searchInput" class="search-input" type="text" placeholder="Search with AI ‚Äî try 'cooking videos from last week'..." oninput="debounceSearch()" />
    <button class="filter-btn" data-filter="all" onclick="setFilter('all', this)">All</button>
    <button class="filter-btn" data-filter="youtube" onclick="setFilter('youtube', this)">
      <svg viewBox="0 0 120 120"><rect x="5" y="22" width="110" height="76" rx="20" ry="20" fill="#FF0000"/><polygon points="50,38 50,82 82,60" fill="#FFF"/></svg>
      YouTube
    </button>
    <button class="filter-btn" data-filter="instagram" onclick="setFilter('instagram', this)">
      <svg viewBox="0 0 120 120"><defs><linearGradient id="igfb" x1="100%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#833AB4"/><stop offset="33%" stop-color="#E1306C"/><stop offset="66%" stop-color="#FD1D1D"/><stop offset="100%" stop-color="#FCAF45"/></linearGradient></defs><rect x="2" y="2" width="116" height="116" rx="30" ry="30" fill="url(#igfb)"/><rect x="18" y="18" width="84" height="84" rx="20" ry="20" fill="none" stroke="#FFF" stroke-width="8"/><circle cx="60" cy="60" r="20" fill="none" stroke="#FFF" stroke-width="8"/><circle cx="88" cy="32" r="6" fill="#FFF"/></svg>
      Instagram
    </button>
    <button class="filter-btn" data-filter="tiktok" onclick="setFilter('tiktok', this)">
      <svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#000"/><g transform="translate(1.5,-1.5)"><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#25F4EE"/></g><g transform="translate(-1.5,1.5)"><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#FE2C55"/></g><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#FFF"/></svg>
      TikTok
    </button>
    <button class="filter-btn" data-filter="twitter" onclick="setFilter('twitter', this)">
      <svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#000"/><polygon points="32,30 48,30 90,90 74,90" fill="#FFF"/><polygon points="82,30 90,30 38,90 28,90" fill="#FFF"/></svg>
      X
    </button>
    <button class="filter-btn" data-filter="facebook" onclick="setFilter('facebook', this)">
      <svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#1877F2"/><path d="M68,46L68,38C68,34 70,32 75,32L82,32L82,20L72,20C62,20 56,27 56,37L56,46L46,46L46,58L56,58L56,100L68,100L68,58L80,58L82,46Z" fill="#FFF"/></svg>
      Facebook
    </button>
    <button class="filter-btn favorites-pill" id="favFilterBtn" onclick="toggleFavoritesFilter(this)">‚òÖ Favorites</button>
  </div>
  <div id="collectionsBar" class="collections-bar" style="display: none;">
    <span class="collections-bar-label">Collections</span>
    <button class="coll-chip active" data-coll="all" onclick="setCollection('all')">All Saves</button>
    <div id="collChips"></div>
    <button class="coll-chip-add" onclick="openCreateCollectionModal()">+ New</button>
    <div class="coll-manage-bar" id="collManageBar" style="display: none;">
      <button class="coll-manage-btn share-btn" onclick="openShareModal()">Share</button>
      <button class="coll-manage-btn rename-btn" onclick="openRenameCollectionModal()" style="color:var(--text-muted);">Rename</button>
      <button class="coll-manage-btn" onclick="deleteSelectedCollection()">Delete</button>
    </div>
  </div>
  <div id="searchHint" class="search-hint" style="display:none;"></div>
  <div id="statsBar" class="stats-bar"></div>
  <div id="cardsGrid" class="cards-grid"></div>
  <div id="emptyState" class="empty-state" style="display: none;">
    <div class="empty-state-icon">üìå</div>
    <h3>No saves yet</h3>
    <p>Paste a URL above to start building your content library. Dopo extracts metadata automatically from YouTube, Instagram, TikTok, X, Facebook, and more.</p>
  </div>
</div>
<!-- Create Collection Modal -->
<div id="createCollModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h3>Create Collection</h3>
    <input id="newCollEmoji" class="modal-field" type="text" placeholder="Auto" maxlength="2" style="width: 80px; display: inline-block; text-align: center; font-size: 20px;" value="" />
    <input id="newCollName" class="modal-field" type="text" placeholder="Collection name" style="width: calc(100% - 100px); display: inline-block; margin-left: 8px;" onkeydown="if(event.key==='Enter')createCollection()" oninput="autoSuggestEmoji()" />
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeCreateCollectionModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="createCollection()">Create</button>
    </div>
  </div>
</div>
<!-- Add to Collection Modal -->
<div id="addToCollModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h3>Add to Collection</h3>
    <div id="addToCollList" style="max-height: 300px; overflow-y: auto;"></div>
    <div class="modal-actions" style="margin-top: 16px;">
      <button class="modal-btn modal-btn-secondary" onclick="closeAddToCollModal()">Done</button>
    </div>
  </div>
</div>
<!-- Share & Collaborate Modal -->
<div id="shareModal" class="modal-overlay hidden">
  <div class="modal-box" style="max-width: 480px;">
    <h3 id="shareModalTitle">Share Collection</h3>
    <!-- Public link section -->
    <div class="share-section">
      <div class="share-section-title">Public Link</div>
      <div class="share-toggle-row">
        <div>
          <div class="share-toggle-label">Make collection public</div>
          <div class="share-toggle-desc">Anyone with the link can view this collection</div>
        </div>
        <button id="shareToggle" class="toggle-switch" onclick="togglePublicShare()"></button>
      </div>
      <div id="shareLinkRow" class="share-link-row" style="display: none;">
        <span id="shareLinkUrl" class="share-link-url"></span>
        <button class="share-link-copy" onclick="copyShareLink()">Copy</button>
      </div>
    </div>
    <!-- Collaborators section -->
    <div class="share-section">
      <div class="share-section-title">Collaborators</div>
      <div id="collabList" class="collab-list"></div>
      <div class="collab-invite-row">
        <input id="collabEmail" class="collab-invite-input" type="email" placeholder="Email address" onkeydown="if(event.key==='Enter')inviteCollaborator()" />
        <select id="collabRoleSelect" class="collab-role-select">
          <option value="editor">Collaborator</option>
          <option value="viewer">View only</option>
        </select>
        <button class="collab-invite-btn" onclick="inviteCollaborator()">Invite</button>
      </div>
      <div id="collabStatus" class="collab-status"></div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeShareModal()">Done</button>
    </div>
  </div>
</div>
<!-- Rename Collection Modal -->
<div id="renameCollModal" class="modal-overlay hidden">
  <div class="modal-box">
    <h3>Rename Collection</h3>
    <input id="renameCollEmoji" class="modal-field" type="text" maxlength="2" style="width: 80px; display: inline-block; text-align: center; font-size: 20px;" />
    <input id="renameCollName" class="modal-field" type="text" placeholder="New name" style="width: calc(100% - 100px); display: inline-block; margin-left: 8px;" onkeydown="if(event.key==='Enter')renameCollection()" />
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" onclick="closeRenameCollectionModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="renameCollection()">Save</button>
    </div>
  </div>
</div>
<!-- Save Detail Modal (slide-up) -->
<div id="detailModal" style="display:none;"></div>
<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" style="display:none;"></div>
<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>
<script>
const SUPABASE_URL = "https://adyqktvkxwohzxzjqpjt.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkeXFrdHZreHdvaHp4empxcGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDY1OTcsImV4cCI6MjA4NjQ4MjU5N30.H5V7HHpIl5o5steAc760Lm1SqjmAYnWiBNrTlrmQHiI";
let accessToken = null;
let currentUser = null;
let currentFilter = "all";
let currentCollection = "all";
let searchTimeout = null;
let isSignUp = false;
let collections = [];
let currentSaves = [];
let addToCollSaveId = null;
let activeCollectionRole = null; // null = own collection or "all", "editor", "viewer"
let favoritesOnly = false;
let featureFlags = {}; // Loaded from /config endpoint on init
const WEB_APP_VERSION = "1.0.0";

// Standard headers for all authenticated API calls (includes platform tracking)
function apiHeaders(includeAuth = true) {
  const h = {
    "Content-Type": "application/json",
    "apikey": SUPABASE_ANON_KEY,
    "x-platform": "web",
    "x-app-version": WEB_APP_VERSION,
  };
  if (includeAuth && accessToken) h["Authorization"] = `Bearer ${accessToken}`;
  return h;
}

// SVG brand logos for each platform (proper brand marks)
const platformSVG = {
  youtube: '<svg viewBox="0 0 120 120"><rect x="5" y="22" width="110" height="76" rx="20" ry="20" fill="#FF0000"/><polygon points="50,38 50,82 82,60" fill="#FFFFFF"/></svg>',
  instagram: '<svg viewBox="0 0 120 120"><defs><linearGradient id="igc" x1="100%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#833AB4"/><stop offset="33%" stop-color="#E1306C"/><stop offset="66%" stop-color="#FD1D1D"/><stop offset="100%" stop-color="#FCAF45"/></linearGradient></defs><rect x="2" y="2" width="116" height="116" rx="30" ry="30" fill="url(#igc)"/><rect x="18" y="18" width="84" height="84" rx="20" ry="20" fill="none" stroke="#FFF" stroke-width="8"/><circle cx="60" cy="60" r="20" fill="none" stroke="#FFF" stroke-width="8"/><circle cx="88" cy="32" r="6" fill="#FFF"/></svg>',
  tiktok: '<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#000"/><g transform="translate(1.5,-1.5)"><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#25F4EE"/></g><g transform="translate(-1.5,1.5)"><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#FE2C55"/></g><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#FFF"/></svg>',
  twitter: '<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#000"/><polygon points="32,30 48,30 90,90 74,90" fill="#FFF"/><polygon points="82,30 90,30 38,90 28,90" fill="#FFF"/></svg>',
  facebook: '<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#1877F2"/><path d="M68,46L68,38C68,34 70,32 75,32L82,32L82,20L72,20C62,20 56,27 56,37L56,46L46,46L46,58L56,58L56,100L68,100L68,58L80,58L82,46Z" fill="#FFF"/></svg>',
  other: '<svg viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" stroke="#8888a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" stroke="#8888a0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
};

// Smaller inline SVGs for filter buttons (14px)
const platformFilterSVG = {
  youtube: '<svg viewBox="0 0 120 120"><rect x="5" y="22" width="110" height="76" rx="20" ry="20" fill="#FF0000"/><polygon points="50,38 50,82 82,60" fill="#FFF"/></svg>',
  instagram: '<svg viewBox="0 0 120 120"><defs><linearGradient id="igf" x1="100%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#833AB4"/><stop offset="33%" stop-color="#E1306C"/><stop offset="66%" stop-color="#FD1D1D"/><stop offset="100%" stop-color="#FCAF45"/></linearGradient></defs><rect x="2" y="2" width="116" height="116" rx="30" ry="30" fill="url(#igf)"/><rect x="18" y="18" width="84" height="84" rx="20" ry="20" fill="none" stroke="#FFF" stroke-width="8"/><circle cx="60" cy="60" r="20" fill="none" stroke="#FFF" stroke-width="8"/><circle cx="88" cy="32" r="6" fill="#FFF"/></svg>',
  tiktok: '<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#000"/><g transform="translate(1.5,-1.5)"><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#25F4EE"/></g><g transform="translate(-1.5,1.5)"><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#FE2C55"/></g><path d="M65,30L65,75C65,83 58,89 50,89C42,89 36,83 36,75C36,67 42,61 50,61C52,61 54,61.5 56,62.5L56,52C54,51.5 52,51 50,51C36,51 25,62 25,75C25,88 36,99 50,99C64,99 75,88 75,75L75,48C79,52 85,55 92,56L92,45C83,44 76,38 74,30Z" fill="#FFF"/></svg>',
  twitter: '<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#000"/><polygon points="32,30 48,30 90,90 74,90" fill="#FFF"/><polygon points="82,30 90,30 38,90 28,90" fill="#FFF"/></svg>',
  facebook: '<svg viewBox="0 0 120 120"><circle cx="60" cy="60" r="58" fill="#1877F2"/><path d="M68,46L68,38C68,34 70,32 75,32L82,32L82,20L72,20C62,20 56,27 56,37L56,46L46,46L46,58L56,58L56,100L68,100L68,58L80,58L82,46Z" fill="#FFF"/></svg>',
};

const platformLabels = {
  youtube: "YouTube",
  instagram: "Instagram",
  tiktok: "TikTok",
  twitter: "X",
  facebook: "Facebook",
  other: "Other"
};

// Smart emoji picker: auto-generates an emoji based on collection name
function smartEmoji(name) {
  const n = (name || "").toLowerCase();
  const map = [
    [/cook|recipe|food|eat|meal|dinner|lunch|breakfast|bak/i, "üç≥"],
    [/music|song|playlist|beat|audio|sound|lyric/i, "üéµ"],
    [/workout|fitness|gym|exercise|lift|run|sport/i, "üí™"],
    [/travel|trip|vacation|flight|hotel|beach|adventure/i, "‚úàÔ∏è"],
    [/tech|code|dev|programming|software|ai|machine/i, "‚ö°"],
    [/design|art|creative|draw|paint|style|aesthetic/i, "üé®"],
    [/photo|camera|shot|portrait|landscape/i, "üì∏"],
    [/video|film|movie|cinema|watch|stream/i, "üé¨"],
    [/game|gaming|play|esport|stream/i, "üéÆ"],
    [/book|read|learn|study|education|school|course/i, "üìö"],
    [/money|finance|invest|crypto|stock|business|budget/i, "üí∞"],
    [/health|medical|wellness|mental|therapy|mindful/i, "üßò"],
    [/fashion|outfit|clothes|wear|shoe|style/i, "üëó"],
    [/home|house|decor|interior|room|furniture|garden/i, "üè°"],
    [/car|auto|drive|motor|vehicle/i, "üèéÔ∏è"],
    [/pet|dog|cat|animal|puppy/i, "üêæ"],
    [/baby|kid|child|parent|family/i, "üë∂"],
    [/news|politics|world|current/i, "üì∞"],
    [/faith|church|bible|spirit|pray|jesus|god|christian/i, "‚úùÔ∏è"],
    [/funny|humor|comedy|meme|laugh|joke/i, "üòÇ"],
    [/beauty|makeup|skin|hair|glow/i, "‚ú®"],
    [/shop|buy|deal|sale|product|review/i, "üõçÔ∏è"],
    [/diy|craft|build|make|project|hack/i, "üîß"],
    [/nature|outdoor|hike|camp|mountain|wild/i, "üåø"],
    [/football|nfl|soccer|basketball|nba|baseball/i, "üèà"],
    [/inspo|inspiration|motivat|quote|goal/i, "üî•"],
    [/save|later|watch|bookmark|keep/i, "üìå"],
    [/fav|favorite|best|top|love/i, "‚ù§Ô∏è"],
    [/work|career|job|hustle|grind|entrepreneur/i, "üíº"],
    [/science|space|nasa|physics|chem/i, "üî¨"],
  ];
  for (const [regex, emoji] of map) {
    if (regex.test(n)) return emoji;
  }
  // Default: pick from a set of modern, clean icons based on first letter
  const defaults = ["‚óæ", "‚óΩ", "‚ñ™Ô∏è", "‚óè", "‚óã"];
  return "‚ú¶";
}

// Clean SVG icon for "add to collection" button (replaces üìÅ)
const addToCollIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="3"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>';

function toggleAuthMode() {
  isSignUp = !isSignUp;
  document.getElementById("authSubmit").textContent = isSignUp ? "Sign Up" : "Sign In";
  document.getElementById("authToggle").innerHTML = isSignUp
    ? 'Already have an account? <a onclick="toggleAuthMode()">Sign in</a>'
    : 'Don\'t have an account? <a onclick="toggleAuthMode()">Sign up</a>';
  document.getElementById("authError").className = "auth-error";
}

async function handleAuth() {
  const email = document.getElementById("authEmail").value.trim();
  const password = document.getElementById("authPassword").value;
  const errorEl = document.getElementById("authError");
  if (!email || !password) { errorEl.textContent = "Please enter email and password"; errorEl.className = "auth-error show"; return; }
  const endpoint = isSignUp ? "signup" : "token?grant_type=password";
  try {
    const resp = await fetch(`${SUPABASE_URL}/auth/v1/${endpoint}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
      body: JSON.stringify({ email, password }),
    });
    const data = await resp.json();
    if (!resp.ok) { errorEl.textContent = data.error_description || data.msg || data.error || "Auth failed"; errorEl.className = "auth-error show"; return; }
    if (isSignUp && !data.access_token) {
      errorEl.textContent = "Account created! Check your email to confirm, then sign in.";
      errorEl.className = "auth-error show"; errorEl.style.color = "var(--success)";
      isSignUp = false; document.getElementById("authSubmit").textContent = "Sign In"; return;
    }
    accessToken = data.access_token;
    currentUser = data.user;
    localStorage.setItem("dopo_token", accessToken);
    showApp();
  } catch (e) { errorEl.textContent = "Network error. Try again."; errorEl.className = "auth-error show"; }
}

async function checkExistingSession() {
  const token = localStorage.getItem("dopo_token");
  if (!token) return false;
  try {
    const resp = await fetch(`${SUPABASE_URL}/auth/v1/user`, { headers: { Authorization: `Bearer ${token}`, apikey: SUPABASE_ANON_KEY } });
    if (resp.ok) { const user = await resp.json(); accessToken = token; currentUser = user; return true; }
  } catch {}
  localStorage.removeItem("dopo_token");
  return false;
}

function handleSignOut() {
  accessToken = null;
  currentUser = null;
  currentCollection = "all";
  collections = [];
  currentSaves = [];
  localStorage.removeItem("dopo_token");
  document.getElementById("app").style.display = "none";
  document.getElementById("authOverlay").style.display = "flex";
  // Clear form fields
  document.getElementById("authEmail").value = "";
  document.getElementById("authPassword").value = "";
  document.getElementById("authError").className = "auth-error";
}

function showApp() {
  document.getElementById("authOverlay").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("userBadge").textContent = currentUser?.email || "";
  loadCollections();
  loadLibrary();
}

async function handleIngest() {
  const input = document.getElementById("ingestInput");
  const url = input.value.trim();
  if (!url) return;
  const btn = document.getElementById("ingestBtn");
  const statusEl = document.getElementById("ingestStatus");
  btn.disabled = true;
  document.getElementById("ingestBtnText").innerHTML = '<span class="spinner"></span>';
  statusEl.className = "ingest-status show loading";
  statusEl.textContent = "Saving and extracting metadata...";
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/ingest`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify({ url }),
    });
    const data = await resp.json();
    if (!resp.ok) {
      statusEl.className = "ingest-status show error";
      statusEl.textContent = data.error === "Already saved" ? "Already in your library!" : `Error: ${data.error}`;
    } else {
      statusEl.className = "ingest-status show success";
      const s = data.save;
      const displayPlatform = platformLabels[s.platform] || s.platform;
      statusEl.textContent = `Saved! ${displayPlatform} ${s.content_type} ‚Äî "${(s.title || "untitled").substring(0, 60)}" by ${s.creator_name || "unknown"}`;
      input.value = "";
      loadLibrary();
    }
  } catch (e) { statusEl.className = "ingest-status show error"; statusEl.textContent = `Network error: ${e.message}`; }
  btn.disabled = false;
  document.getElementById("ingestBtnText").textContent = "Save";
  setTimeout(() => { statusEl.className = "ingest-status"; }, 5000);
}

function toggleBulk() { document.getElementById("bulkArea").classList.toggle("show"); }

async function handleBulkIngest() {
  const textarea = document.getElementById("bulkTextarea");
  const urls = textarea.value.split("\n").map(u => u.trim()).filter(u => u.startsWith("http"));
  if (urls.length === 0) return;
  const btn = document.getElementById("bulkBtn");
  const progress = document.getElementById("bulkProgress");
  btn.disabled = true;
  let success = 0, failed = 0, dupes = 0;
  for (let i = 0; i < urls.length; i++) {
    progress.textContent = `Processing ${i + 1}/${urls.length}...`;
    try {
      const resp = await fetch(`${SUPABASE_URL}/functions/v1/ingest`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
        body: JSON.stringify({ url: urls[i] }),
      });
      if (resp.status === 409) dupes++;
      else if (resp.ok) success++;
      else failed++;
    } catch { failed++; }
    await new Promise(r => setTimeout(r, 800));
  }
  progress.textContent = `Done! ${success} saved, ${dupes} duplicates, ${failed} failed`;
  btn.disabled = false;
  textarea.value = "";
  loadLibrary();
}

function showLoadingSkeleton() {
  const grid = document.getElementById("cardsGrid");
  const skeletons = Array(6).fill(0).map(() => `<div class="skeleton-card">
    <div class="skeleton-thumb"></div>
    <div class="skeleton-body">
      <div class="skeleton-line short"></div>
      <div class="skeleton-line long"></div>
      <div class="skeleton-line medium"></div>
    </div>
  </div>`).join("");
  grid.innerHTML = skeletons;
}

async function loadLibrary(query = "") {
  const grid = document.getElementById("cardsGrid");
  const empty = document.getElementById("emptyState");
  const stats = document.getElementById("statsBar");
  const hint = document.getElementById("searchHint");
  // Show skeleton on initial load or collection switch (not on search debounce)
  if (!query && currentSaves.length === 0) showLoadingSkeleton();
  // Hide search hint by default
  hint.style.display = "none";

  // Use smart-search when there's a query, standard library otherwise
  if (query) {
    await smartSearchLibrary(query, grid, empty, stats, hint);
  } else {
    await fetchStandardLibrary(query, grid, empty, stats);
  }
}

async function smartSearchLibrary(query, grid, empty, stats, hint) {
  try {
    const body = { q: query, limit: 50 };
    if (currentFilter !== "all") body.platform = currentFilter;
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/smart-search`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify(body),
    });
    const data = await resp.json();
    if (!resp.ok) {
      // Fall back to standard library search on error
      await fetchStandardLibrary(query, grid, empty, stats);
      return;
    }
    const saves = data.saves || [];
    currentSaves = saves;
    const method = data.search_method || "smart";
    stats.innerHTML = `‚ú® ${saves.length} result${saves.length !== 1 ? "s" : ""} <span style="color:var(--text-dim);font-size:11px;">(${method} search)</span>`;
    // Show parsed query hints
    if (data.parsed) {
      const parts = [];
      if (data.parsed.semantic_query) parts.push(`<span class="search-hint-tag">"${esc(data.parsed.semantic_query)}"</span>`);
      if (data.parsed.platform) parts.push(`<span class="search-hint-tag">üì± ${esc(platformLabels[data.parsed.platform] || data.parsed.platform)}</span>`);
      if (data.parsed.content_type) parts.push(`<span class="search-hint-tag">üé¨ ${esc(data.parsed.content_type)}</span>`);
      if (data.parsed.temporal) parts.push(`<span class="search-hint-tag">üìÖ ${esc(data.parsed.temporal)}</span>`);
      if (parts.length > 0) {
        hint.innerHTML = `‚ú® AI understood: ${parts.join(" ")}`;
        hint.style.display = "flex";
      }
    }
    if (saves.length === 0) {
      grid.innerHTML = "";
      empty.style.display = "block";
      empty.querySelector("h3").textContent = "No results";
      empty.querySelector("p").textContent = `No saves matching "${query}". Try different search terms.`;
    } else {
      empty.style.display = "none";
      grid.innerHTML = saves.map(renderCard).join("");
    }
  } catch (e) {
    // Fall back to standard library on network error
    await fetchStandardLibrary(query, grid, empty, stats);
  }
}

async function fetchStandardLibrary(query, grid, empty, stats) {
  let url = `${SUPABASE_URL}/functions/v1/library?limit=50`;
  if (query) url += `&q=${encodeURIComponent(query)}`;
  if (currentFilter !== "all") url += `&platform=${currentFilter}`;
  if (currentCollection !== "all") url += `&collection=${currentCollection}`;
  if (favoritesOnly) url += `&favorites=true`;
  try {
    const resp = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY } });
    const data = await resp.json();
    if (!resp.ok) { grid.innerHTML = `<div style="color:var(--error);grid-column:1/-1;">Error: ${data.error}</div>`; return; }
    const saves = data.saves || [];
    currentSaves = saves;
    const total = data.total || saves.length;
    const collLabel = currentCollection !== "all" ? ` in collection` : " in library";
    stats.textContent = query ? `${saves.length} result${saves.length !== 1 ? "s" : ""} for "${query}"` : `${total} save${total !== 1 ? "s" : ""}${collLabel}`;
    if (saves.length === 0) {
      grid.innerHTML = "";
      empty.style.display = "block";
      empty.querySelector("h3").textContent = query ? "No results" : "No saves yet";
      empty.querySelector("p").textContent = query ? `No saves matching "${query}". Try different search terms.` : "Paste a URL above to start building your content library.";
    } else {
      empty.style.display = "none";
      grid.innerHTML = saves.map(renderCard).join("");
    }
  } catch (e) { grid.innerHTML = `<div style="color:var(--error);grid-column:1/-1;">Failed to load: ${e.message}</div>`; }
}

function renderCard(save) {
  const p = save.platform || "other";
  const icon = platformSVG[p] || platformSVG.other;
  const label = platformLabels[p] || "Other";
  const title = save.title || save.canonical_url || save.url;
  const thumb = save.thumbnail_url;
  const tags = [...(save.ai_tags || []), ...(save.tags || [])];
  const uniqueTags = [...new Set(tags)];
  const logoOverlay = `<div class="card-platform-overlay">${icon}</div>`;
  const thumbHtml = thumb
    ? `<div class="card-thumb-wrap"><div class="card-thumb-placeholder ${p}">${icon}</div><img class="card-thumb" src="${esc(thumb)}" alt="" loading="lazy" onerror="this.style.display='none'" />${logoOverlay}</div>`
    : `<div class="card-thumb-placeholder ${p}">${icon}</div>`;
  const tagsHtml = uniqueTags.slice(0, 5).map(t => `<span class="card-tag">#${esc(t)}</span>`).join("");
  const dateStr = save.saved_at ? new Date(save.saved_at).toLocaleDateString("en-US", { month: "short", day: "numeric" }) : "";
  const categoryHtml = save.category && save.category !== 'other' ? `<span class="card-tag" style="background:var(--accent-glow);color:var(--accent);">${esc(save.category)}</span>` : "";
  return `<div class="card" onclick="openDetailModal('${save.id}')" style="cursor:pointer;">
    <div class="card-enrichment ${save.enrichment_status||'pending'}" title="Enrichment: ${save.enrichment_status||'pending'}"></div>
    ${thumbHtml}
    <div class="card-body">
      <div><span class="card-platform ${p}">${icon} ${label}</span><span class="card-content-type">${save.content_type||""}</span></div>
      <div class="card-title">${esc(title.substring(0,200))}</div>
      ${save.creator_name ? `<div class="card-creator">${esc(save.creator_name)}${save.creator_handle ? ` <span class="card-creator-handle">${esc(save.creator_handle)}</span>` : ""}</div>` : ""}
      ${(tagsHtml || categoryHtml) ? `<div class="card-tags">${categoryHtml}${tagsHtml}</div>` : ""}
      <div class="card-meta">
        <span class="card-date">${dateStr}</span>
        <div class="card-actions" onclick="event.stopPropagation()">
          ${activeCollectionRole !== 'viewer' ? `<button class="card-action" onclick="openAddToCollModal('${save.id}')" title="Add to collection">${addToCollIcon}</button>` : ''}
          <button class="card-action ${save.is_favorite?'favorited':''}" onclick="toggleFav('${save.id}',${!save.is_favorite})" title="Favorite">${save.is_favorite?"‚òÖ":"‚òÜ"}</button>
          ${save.user_id === currentUser?.id ? `<button class="card-action delete-btn" onclick="confirmDeleteSave('${save.id}','${esc(title.substring(0,50)).replace(/'/g,"\\'")}')" title="Delete save">üóë</button>` : ''}
          <a class="card-link" href="${esc(save.canonical_url||save.url)}" target="_blank" rel="noopener">Open ‚Üó</a>
        </div>
      </div>
    </div>
  </div>`;
}

function esc(s) { if(!s)return""; return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

async function toggleFav(id, newState) {
  try {
    await fetch(`${SUPABASE_URL}/functions/v1/library`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify({ id, is_favorite: newState }),
    });
    loadLibrary(document.getElementById("searchInput").value);
  } catch {}
}

function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  loadLibrary(document.getElementById("searchInput").value);
}

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => { loadLibrary(document.getElementById("searchInput").value.trim()); }, 300);
}

// ‚îÄ‚îÄ‚îÄ COLLECTIONS ‚îÄ‚îÄ‚îÄ
async function loadCollections() {
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collections`, {
      headers: { Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY }
    });
    const data = await resp.json();
    collections = data.collections || [];
    renderCollectionsBar();
  } catch (e) { console.error("Failed to load collections", e); }
}

function renderCollectionsBar() {
  const bar = document.getElementById("collectionsBar");
  const chips = document.getElementById("collChips");
  const manageBar = document.getElementById("collManageBar");
  bar.style.display = "flex";
  chips.innerHTML = collections.map(c => {
    const publicIcon = c.is_public ? ' üîó' : '';
    let sharedIcon = '';
    if (!c.is_owner && c.role === 'editor') sharedIcon = ' üë•';
    else if (!c.is_owner && c.role === 'viewer') sharedIcon = ' üëÅÔ∏è';
    return `<button class="coll-chip ${currentCollection === c.id ? 'active' : ''}" data-coll="${c.id}" onclick="setCollection('${c.id}')">${c.emoji || '‚ú¶'} ${esc(c.name)}${publicIcon}${sharedIcon} <span class="coll-count">${c.save_count}</span></button>`;
  }).join("");
  // Update "All Saves" active state
  document.querySelector('[data-coll="all"]').className = `coll-chip ${currentCollection === 'all' ? 'active' : ''}`;
  // Show manage bar when a specific collection is selected
  if (currentCollection !== "all") {
    manageBar.style.display = "flex";
    const coll = collections.find(c => c.id === currentCollection);
    const isOwner = coll?.is_owner;
    // Share button: only visible to owner
    const shareBtn = manageBar.querySelector('.share-btn');
    const renameBtn = manageBar.querySelector('.rename-btn');
    const deleteBtn = manageBar.querySelector('.coll-manage-btn:not(.share-btn):not(.rename-btn)');
    if (shareBtn) shareBtn.style.display = isOwner ? 'inline-block' : 'none';
    if (renameBtn) renameBtn.style.display = isOwner ? 'inline-block' : 'none';
    if (deleteBtn) deleteBtn.style.display = isOwner ? 'inline-block' : 'none';
  } else {
    manageBar.style.display = "none";
  }
}

function setCollection(collId) {
  currentCollection = collId;
  // Determine the user's role for this collection
  if (collId === "all") {
    activeCollectionRole = null;
  } else {
    const coll = collections.find(c => c.id === collId);
    if (coll && !coll.is_owner) {
      activeCollectionRole = coll.role || "viewer";
    } else {
      activeCollectionRole = null; // owner ‚Äî full access
    }
  }
  renderCollectionsBar();
  enforceRoleUI();
  loadLibrary(document.getElementById("searchInput").value.trim());
}

function enforceRoleUI() {
  const isViewOnly = activeCollectionRole === "viewer";
  const isSharedCollection = activeCollectionRole !== null;
  // Ingest bar: hide for view-only
  const ingestSection = document.querySelector(".ingest-section");
  if (ingestSection) ingestSection.style.display = isViewOnly ? "none" : "block";
  // Remove or add viewer notice
  let notice = document.getElementById("viewerNotice");
  if (isViewOnly) {
    if (!notice) {
      notice = document.createElement("div");
      notice.id = "viewerNotice";
      notice.className = "viewer-notice";
      notice.innerHTML = 'üëÅÔ∏è <span>You have <strong>view-only</strong> access to this collection</span>';
      const statsBar = document.getElementById("statsBar");
      statsBar.parentNode.insertBefore(notice, statsBar);
    }
    notice.style.display = "flex";
  } else {
    if (notice) notice.style.display = "none";
  }
}

function openCreateCollectionModal() {
  document.getElementById("createCollModal").classList.remove("hidden");
  document.getElementById("newCollName").value = "";
  document.getElementById("newCollEmoji").value = "";
  document.getElementById("newCollEmoji").placeholder = "Auto";
  setTimeout(() => document.getElementById("newCollName").focus(), 100);
}

function autoSuggestEmoji() {
  const name = document.getElementById("newCollName").value.trim();
  const emojiField = document.getElementById("newCollEmoji");
  // Only auto-suggest if user hasn't manually typed an emoji
  if (emojiField.dataset.manual === "true") return;
  if (name) {
    emojiField.value = smartEmoji(name);
  } else {
    emojiField.value = "";
    emojiField.placeholder = "Auto";
  }
}


function closeCreateCollectionModal() {
  document.getElementById("createCollModal").classList.add("hidden");
}

async function createCollection() {
  const name = document.getElementById("newCollName").value.trim();
  const emoji = document.getElementById("newCollEmoji").value.trim() || smartEmoji(name);
  if (!name) return;
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collections`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify({ name, emoji }),
    });
    if (resp.ok) {
      closeCreateCollectionModal();
      await loadCollections();
    }
  } catch (e) { console.error("Failed to create collection", e); }
}

async function deleteSelectedCollection() {
  if (currentCollection === "all") return;
  const coll = collections.find(c => c.id === currentCollection);
  if (!coll || !confirm(`Delete collection "${coll.name}"? The saves inside won't be deleted.`)) return;
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collections?id=${currentCollection}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
    });
    if (resp.ok) {
      currentCollection = "all";
      await loadCollections();
      loadLibrary(document.getElementById("searchInput").value.trim());
    }
  } catch (e) { console.error("Failed to delete collection", e); }
}

function openAddToCollModal(saveId) {
  addToCollSaveId = saveId;
  const modal = document.getElementById("addToCollModal");
  const list = document.getElementById("addToCollList");
  // Filter to collections user can edit (owned or editor role)
  const editableColls = collections.filter(c => c.is_owner || c.role === 'editor');
  if (editableColls.length === 0) {
    list.innerHTML = `<div style="color:var(--text-dim);padding:16px;text-align:center;">No collections yet. Create one first!</div>`;
  } else {
    list.innerHTML = editableColls.map(c => {
      const sharedLabel = !c.is_owner ? ' <span style="font-size:10px;color:var(--text-dim);">(shared)</span>' : '';
      return `<button class="card-coll-dropdown-item" id="coll-toggle-${c.id}" onclick="toggleSaveInCollection('${saveId}','${c.id}', this)">
        <span class="coll-check" id="coll-check-${c.id}">‚Äì</span>
        ${c.emoji || '‚ú¶'} ${esc(c.name)}${sharedLabel}
      </button>`;
    }).join("");
    checkMemberships(saveId);
  }
  modal.classList.remove("hidden");
}

function checkMemberships(saveId) {
  const save = currentSaves.find(s => s.id === saveId);
  const collIds = save?.collection_ids || [];
  collections.forEach(c => {
    const check = document.getElementById(`coll-check-${c.id}`);
    if (check) check.textContent = collIds.includes(c.id) ? "‚úì" : "";
  });
}

function closeAddToCollModal() {
  document.getElementById("addToCollModal").classList.add("hidden");
  addToCollSaveId = null;
  loadCollections();
  loadLibrary(document.getElementById("searchInput").value.trim());
}

// ‚îÄ‚îÄ‚îÄ SHARE & COLLABORATE ‚îÄ‚îÄ‚îÄ
let shareCollectionId = null;
let shareCollectionData = null;

function openShareModal() {
  if (currentCollection === "all") return;
  shareCollectionId = currentCollection;
  const coll = collections.find(c => c.id === currentCollection);
  if (!coll) return;
  shareCollectionData = coll;
  document.getElementById("shareModalTitle").textContent = `Share "${coll.name}"`;
  // Set toggle state
  const toggle = document.getElementById("shareToggle");
  toggle.className = `toggle-switch ${coll.is_public ? 'on' : ''}`;
  // Show/hide link
  updateShareLinkDisplay(coll);
  // Load collaborators
  loadCollaborators(coll.id);
  document.getElementById("shareModal").classList.remove("hidden");
}

function closeShareModal() {
  document.getElementById("shareModal").classList.add("hidden");
  shareCollectionId = null;
  shareCollectionData = null;
  document.getElementById("collabStatus").textContent = "";
  document.getElementById("collabEmail").value = "";
  loadCollections(); // refresh counts/state
}

async function togglePublicShare() {
  if (!shareCollectionId) return;
  const toggle = document.getElementById("shareToggle");
  const newState = !toggle.classList.contains("on");
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collections`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify({ action: "toggle_share", collection_id: shareCollectionId, is_public: newState }),
    });
    const data = await resp.json();
    if (resp.ok && data.collection) {
      toggle.className = `toggle-switch ${data.collection.is_public ? 'on' : ''}`;
      shareCollectionData = { ...shareCollectionData, ...data.collection };
      // Update in collections array too
      const idx = collections.findIndex(c => c.id === shareCollectionId);
      if (idx >= 0) { collections[idx].is_public = data.collection.is_public; collections[idx].share_token = data.collection.share_token; }
      updateShareLinkDisplay(shareCollectionData);
    }
  } catch (e) { console.error("Failed to toggle share", e); }
}

function updateShareLinkDisplay(coll) {
  const row = document.getElementById("shareLinkRow");
  const urlEl = document.getElementById("shareLinkUrl");
  if (coll.is_public && coll.share_token) {
    const shareUrl = `${window.location.origin}${window.location.pathname}?shared=${coll.share_token}`;
    urlEl.textContent = shareUrl;
    row.style.display = "flex";
  } else {
    row.style.display = "none";
  }
}

function copyShareLink() {
  const url = document.getElementById("shareLinkUrl").textContent;
  navigator.clipboard.writeText(url).then(() => {
    const btn = document.querySelector(".share-link-copy");
    btn.textContent = "Copied!";
    setTimeout(() => { btn.textContent = "Copy"; }, 2000);
  });
}

async function loadCollaborators(collId) {
  const list = document.getElementById("collabList");
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collaborators?collection_id=${collId}`, {
      headers: { Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY }
    });
    const data = await resp.json();
    const collabs = data.collaborators || [];
    const isOwner = data.is_owner;
    if (collabs.length === 0) {
      list.innerHTML = `<div style="color:var(--text-dim);font-size:13px;padding:8px 0;">No collaborators yet</div>`;
    } else {
      list.innerHTML = collabs.map(c => {
        const roleLabel = c.role === 'viewer' ? 'View only' : 'Collaborator';
        const pendingLabel = !c.accepted ? ' (pending)' : '';
        const toggleRole = c.role === 'viewer' ? 'editor' : 'viewer';
        const toggleLabel = c.role === 'viewer' ? 'Make collaborator' : 'Make viewer';
        return `<div class="collab-row">
          <span class="collab-email">${esc(c.email || c.invited_email || 'unknown')}</span>
          <span style="display:flex;align-items:center;gap:6px;">
            <span class="collab-role-badge ${c.role}">${roleLabel}${pendingLabel}</span>
            ${isOwner ? `<button class="collab-role-change" onclick="changeCollabRole('${c.id}','${c.email || c.invited_email}','${toggleRole}')" title="${toggleLabel}">${toggleLabel}</button>` : ''}
            ${isOwner ? `<button class="collab-remove" onclick="removeCollaborator('${c.id}')" title="Remove">&times;</button>` : ''}
          </span>
        </div>`;
      }).join("");
    }
  } catch (e) {
    list.innerHTML = `<div style="color:var(--text-dim);font-size:13px;padding:8px 0;">No collaborators yet</div>`;
  }
}

async function inviteCollaborator() {
  const emailInput = document.getElementById("collabEmail");
  const roleSelect = document.getElementById("collabRoleSelect");
  const status = document.getElementById("collabStatus");
  const email = emailInput.value.trim();
  const role = roleSelect.value;
  if (!email || !shareCollectionId) return;
  status.textContent = "Inviting...";
  status.style.color = "var(--text-muted)";
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collaborators`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify({ collection_id: shareCollectionId, email, role }),
    });
    const data = await resp.json();
    if (resp.ok) {
      const roleLabel = role === "viewer" ? "viewer" : "collaborator";
      status.textContent = data.status === "invited" ? `${email} added as ${roleLabel}!` : `Invite saved ‚Äî ${email} will get access as ${roleLabel} when they sign up`;
      status.style.color = "var(--success)";
      emailInput.value = "";
      loadCollaborators(shareCollectionId);
    } else {
      status.textContent = data.error || "Failed to invite";
      status.style.color = "var(--error)";
    }
  } catch (e) {
    status.textContent = "Network error";
    status.style.color = "var(--error)";
  }
  setTimeout(() => { status.textContent = ""; }, 4000);
}

async function removeCollaborator(collabId) {
  if (!shareCollectionId) return;
  try {
    await fetch(`${SUPABASE_URL}/functions/v1/library/collaborators?id=${collabId}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
    });
    loadCollaborators(shareCollectionId);
  } catch (e) { console.error("Failed to remove collaborator", e); }
}

async function changeCollabRole(collabId, email, newRole) {
  if (!shareCollectionId) return;
  const status = document.getElementById("collabStatus");
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collaborators`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify({ collection_id: shareCollectionId, email, role: newRole }),
    });
    if (resp.ok) {
      const label = newRole === 'viewer' ? 'view only' : 'collaborator';
      status.textContent = `${email} changed to ${label}`;
      status.style.color = "var(--success)";
      loadCollaborators(shareCollectionId);
      setTimeout(() => { status.textContent = ""; }, 3000);
    }
  } catch (e) { console.error("Failed to change role", e); }
}

// ‚îÄ‚îÄ‚îÄ SHARED VIEW (public collection via URL param) ‚îÄ‚îÄ‚îÄ
async function checkSharedView() {
  const params = new URLSearchParams(window.location.search);
  const shareToken = params.get("shared");
  if (!shareToken) return false;
  // Load shared collection
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/shared/${shareToken}`, {
      headers: { apikey: SUPABASE_ANON_KEY }
    });
    if (!resp.ok) return false;
    const data = await resp.json();
    renderSharedView(data);
    return true;
  } catch { return false; }
}

function renderSharedView(data) {
  // Hide auth and app, show shared view
  document.getElementById("authOverlay").style.display = "none";
  document.getElementById("app").style.display = "none";
  const container = document.createElement("div");
  container.className = "app";
  container.style.display = "block";
  const coll = data.collection;
  const saves = data.saves || [];
  container.innerHTML = `
    <header class="header">
      <div><div class="logo">dopo</div><div class="logo-sub">shared collection</div></div>
      <div class="header-right">
        <span class="user-badge">by ${esc(data.owner)}</span>
        <a href="${window.location.pathname}" class="sign-out-btn" style="text-decoration:none;">Sign In</a>
      </div>
    </header>
    <div style="margin-bottom:24px;">
      <h2 style="font-size:22px;margin-bottom:4px;">${coll.emoji || 'üìÅ'} ${esc(coll.name)}</h2>
      ${coll.description ? `<p style="color:var(--text-muted);font-size:14px;">${esc(coll.description)}</p>` : ''}
      <div class="stats-bar" style="margin-top:8px;">${saves.length} save${saves.length !== 1 ? 's' : ''}</div>
    </div>
    <div class="cards-grid">${saves.map(renderSharedCard).join("")}</div>
    ${saves.length === 0 ? '<div class="empty-state"><div class="empty-state-icon">üìå</div><h3>Empty collection</h3><p>This collection doesn\'t have any saves yet.</p></div>' : ''}
  `;
  document.body.appendChild(container);
}

function renderSharedCard(save) {
  const p = save.platform || "other";
  const icon = platformSVG[p] || platformSVG.other;
  const label = platformLabels[p] || "Other";
  const title = save.title || save.canonical_url || save.url;
  const thumb = save.thumbnail_url;
  const tags = [...(save.ai_tags || [])];
  const logoOverlay = `<div class="card-platform-overlay">${icon}</div>`;
  const thumbHtml = thumb
    ? `<div class="card-thumb-wrap"><div class="card-thumb-placeholder ${p}">${icon}</div><img class="card-thumb" src="${esc(thumb)}" alt="" loading="lazy" onerror="this.style.display='none'" />${logoOverlay}</div>`
    : `<div class="card-thumb-placeholder ${p}">${icon}</div>`;
  const tagsHtml = tags.slice(0, 5).map(t => `<span class="card-tag">#${esc(t)}</span>`).join("");
  const dateStr = save.saved_at ? new Date(save.saved_at).toLocaleDateString("en-US", { month: "short", day: "numeric" }) : "";
  const categoryHtml = save.category && save.category !== 'other' ? `<span class="card-tag" style="background:var(--accent-glow);color:var(--accent);">${esc(save.category)}</span>` : "";
  return `<div class="card">
    ${thumbHtml}
    <div class="card-body">
      <div><span class="card-platform ${p}">${icon} ${label}</span><span class="card-content-type">${save.content_type||""}</span></div>
      <div class="card-title">${esc(title.substring(0,200))}</div>
      ${save.creator_name ? `<div class="card-creator">${esc(save.creator_name)}${save.creator_handle ? ` <span class="card-creator-handle">${esc(save.creator_handle)}</span>` : ""}</div>` : ""}
      ${(tagsHtml || categoryHtml) ? `<div class="card-tags">${categoryHtml}${tagsHtml}</div>` : ""}
      <div class="card-meta">
        <span class="card-date">${dateStr}</span>
        <a class="card-link" href="${esc(save.canonical_url||save.url)}" target="_blank" rel="noopener">Open ‚Üó</a>
      </div>
    </div>
  </div>`;
}

async function toggleSaveInCollection(saveId, collId, btn) {
  const check = document.getElementById(`coll-check-${collId}`);
  const isIn = check.textContent === "‚úì";
  const action = isIn ? "remove_save" : "add_save";
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collections`, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
      body: JSON.stringify({ action, collection_id: collId, save_id: saveId }),
    });
    if (resp.ok) {
      check.textContent = isIn ? "" : "‚úì";
    }
  } catch (e) { console.error("Failed to toggle collection membership", e); }
}

// ‚îÄ‚îÄ‚îÄ FAVORITES FILTER ‚îÄ‚îÄ‚îÄ
function toggleFavoritesFilter(btn) {
  favoritesOnly = !favoritesOnly;
  btn.classList.toggle("active", favoritesOnly);
  loadLibrary(document.getElementById("searchInput").value.trim());
}

// ‚îÄ‚îÄ‚îÄ RENAME COLLECTION ‚îÄ‚îÄ‚îÄ
function openRenameCollectionModal() {
  if (currentCollection === "all") return;
  const coll = collections.find(c => c.id === currentCollection);
  if (!coll || !coll.is_owner) return;
  document.getElementById("renameCollName").value = coll.name;
  document.getElementById("renameCollEmoji").value = coll.emoji || "üìÅ";
  document.getElementById("renameCollModal").classList.remove("hidden");
  setTimeout(() => document.getElementById("renameCollName").focus(), 100);
}

function closeRenameCollectionModal() {
  document.getElementById("renameCollModal").classList.add("hidden");
}

async function renameCollection() {
  const name = document.getElementById("renameCollName").value.trim();
  const emoji = document.getElementById("renameCollEmoji").value.trim() || "üìÅ";
  if (!name || currentCollection === "all") return;
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collections`, {
      method: "PATCH",
      headers: apiHeaders(),
      body: JSON.stringify({ id: currentCollection, name, emoji }),
    });
    if (resp.ok) {
      closeRenameCollectionModal();
      showToast("Collection renamed", "success");
      await loadCollections();
    } else {
      const data = await resp.json();
      showToast(data.error || "Failed to rename", "error");
    }
  } catch (e) { showToast("Network error", "error"); }
}

// ‚îÄ‚îÄ‚îÄ DETAIL MODAL (slide-up) ‚îÄ‚îÄ‚îÄ
let detailSaveId = null;
let detailSaveData = null;

function openDetailModal(saveId) {
  const save = currentSaves.find(s => s.id === saveId);
  if (!save) return;
  detailSaveId = saveId;
  detailSaveData = { ...save };
  const modal = document.getElementById("detailModal");
  const p = save.platform || "other";
  const icon = platformSVG[p] || platformSVG.other;
  const label = platformLabels[p] || "Other";
  const title = save.title || save.canonical_url || save.url;
  const tags = [...new Set([...(save.ai_tags || []), ...(save.tags || [])])];
  const dateStr = save.saved_at ? new Date(save.saved_at).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }) : "";
  const isOwner = save.user_id === currentUser?.id;
  const collIds = save.collection_ids || [];

  // Build collection toggles
  const editableColls = collections.filter(c => c.is_owner || c.role === 'editor');
  const collHtml = editableColls.map(c => {
    const isIn = collIds.includes(c.id);
    return `<button class="detail-coll-chip ${isIn ? '' : 'inactive'}" id="detail-coll-${c.id}" onclick="toggleDetailCollection('${saveId}','${c.id}', this)">${c.emoji || '‚ú¶'} ${esc(c.name)}</button>`;
  }).join("") || '<span style="color:var(--text-dim);font-size:12px;">No collections yet</span>';

  modal.style.display = "";
  modal.innerHTML = `<div class="detail-modal-overlay" onclick="if(event.target===this)closeDetailModal()">
    <div class="detail-modal-content">
      <div class="detail-modal-header">
        <h3>Save Details</h3>
        <button class="detail-modal-close" onclick="closeDetailModal()">&times;</button>
      </div>
      <div class="detail-modal-body">
        ${save.thumbnail_url ? `<img class="detail-thumb" src="${esc(save.thumbnail_url)}" alt="" onerror="this.style.display='none'" />` : ''}
        <div class="detail-info-row">
          <span class="detail-info-pill" style="background:rgba(136,136,160,0.1);color:var(--text-muted);">${icon} ${label}</span>
          ${save.content_type ? `<span class="detail-info-pill" style="background:rgba(136,136,160,0.1);color:var(--text-dim);">${save.content_type}</span>` : ''}
          <span class="detail-info-pill" style="background:rgba(136,136,160,0.1);color:var(--text-dim);">üìÖ ${dateStr}</span>
          ${save.is_favorite ? '<span class="detail-info-pill" style="background:var(--accent-glow);color:var(--accent);">‚òÖ Favorite</span>' : ''}
        </div>
        ${save.creator_name ? `<div style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">by ${esc(save.creator_name)}${save.creator_handle ? ` <span style="color:var(--accent);">${esc(save.creator_handle)}</span>` : ''}</div>` : ''}
        ${save.ai_summary ? `<div style="font-size:13px;color:var(--text-muted);margin-bottom:16px;line-height:1.5;padding:10px 14px;background:var(--bg);border-radius:8px;border:1px solid var(--border);">${esc(save.ai_summary)}</div>` : ''}

        ${isOwner ? `
        <div class="detail-field-group">
          <div class="detail-field-label">Title</div>
          <input class="detail-field-input" id="detailTitle" value="${esc(title)}" />
        </div>

        <div class="detail-field-group">
          <div class="detail-field-label">Tags</div>
          <div class="detail-tags-input-wrap" id="detailTagsWrap">
            ${tags.map(t => `<span class="detail-tag-chip" data-tag="${esc(t)}">#${esc(t)} <button class="detail-tag-remove" onclick="removeDetailTag(this,'${esc(t)}')">&times;</button></span>`).join("")}
            <input class="detail-tag-add-input" id="detailTagInput" placeholder="Add tag..." onkeydown="if(event.key==='Enter'){event.preventDefault();addDetailTag()}" />
          </div>
        </div>

        <div class="detail-field-group">
          <div class="detail-field-label">Collections</div>
          <div class="detail-collections-list" id="detailCollections">${collHtml}</div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
          <a class="card-link" href="${esc(save.canonical_url||save.url)}" target="_blank" rel="noopener" style="padding:10px 16px;font-size:13px;">Open Original ‚Üó</a>
          <button class="detail-save-btn" onclick="saveDetailChanges()">Save Changes</button>
        </div>
        ` : `
        <div class="detail-field-group">
          <div class="detail-field-label">Title</div>
          <div style="font-size:14px;color:var(--text);padding:8px 0;">${esc(title)}</div>
        </div>
        ${tags.length > 0 ? `<div class="detail-field-group"><div class="detail-field-label">Tags</div><div class="detail-tags-input-wrap">${tags.map(t => `<span class="detail-tag-chip">#${esc(t)}</span>`).join("")}</div></div>` : ''}
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
          <a class="card-link" href="${esc(save.canonical_url||save.url)}" target="_blank" rel="noopener" style="padding:10px 16px;font-size:13px;">Open Original ‚Üó</a>
        </div>
        `}
      </div>
    </div>
  </div>`;
}

function closeDetailModal() {
  document.getElementById("detailModal").style.display = "none";
  detailSaveId = null;
  detailSaveData = null;
}

function removeDetailTag(btn, tag) {
  btn.closest('.detail-tag-chip').remove();
}

function addDetailTag() {
  const input = document.getElementById("detailTagInput");
  const tag = input.value.trim().replace(/^#/, '');
  if (!tag) return;
  const wrap = document.getElementById("detailTagsWrap");
  const chip = document.createElement("span");
  chip.className = "detail-tag-chip";
  chip.dataset.tag = tag;
  chip.innerHTML = `#${esc(tag)} <button class="detail-tag-remove" onclick="removeDetailTag(this,'${esc(tag)}')">&times;</button>`;
  wrap.insertBefore(chip, input);
  input.value = "";
}

async function toggleDetailCollection(saveId, collId, btn) {
  const isIn = !btn.classList.contains("inactive");
  const action = isIn ? "remove_save" : "add_save";
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library/collections`, {
      method: "POST",
      headers: apiHeaders(),
      body: JSON.stringify({ action, collection_id: collId, save_id: saveId }),
    });
    if (resp.ok) {
      btn.classList.toggle("inactive", isIn);
      // Update local data
      const save = currentSaves.find(s => s.id === saveId);
      if (save) {
        if (!save.collection_ids) save.collection_ids = [];
        if (isIn) save.collection_ids = save.collection_ids.filter(id => id !== collId);
        else save.collection_ids.push(collId);
      }
    }
  } catch (e) { console.error("Failed to toggle collection", e); }
}

async function saveDetailChanges() {
  if (!detailSaveId) return;
  const titleInput = document.getElementById("detailTitle");
  const tagChips = document.querySelectorAll("#detailTagsWrap .detail-tag-chip");
  const newTitle = titleInput ? titleInput.value.trim() : null;
  const newTags = Array.from(tagChips).map(c => c.dataset.tag).filter(Boolean);

  const updates = {};
  if (newTitle && newTitle !== (detailSaveData.title || '')) updates.title = newTitle;
  updates.tags = newTags;

  if (Object.keys(updates).length === 0 && newTags.length === 0) {
    closeDetailModal();
    return;
  }

  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library`, {
      method: "PATCH",
      headers: apiHeaders(),
      body: JSON.stringify({ id: detailSaveId, ...updates }),
    });
    if (resp.ok) {
      showToast("Changes saved", "success");
      closeDetailModal();
      loadLibrary(document.getElementById("searchInput").value.trim());
    } else {
      const data = await resp.json();
      showToast(data.error || "Failed to save", "error");
    }
  } catch (e) { showToast("Network error", "error"); }
}

// ‚îÄ‚îÄ‚îÄ DELETE SAVE ‚îÄ‚îÄ‚îÄ
function confirmDeleteSave(saveId, title) {
  const modal = document.getElementById("deleteConfirmModal");
  modal.style.display = "";
  modal.innerHTML = `<div class="confirm-delete-overlay" onclick="if(event.target===this)closeDeleteConfirm()">
    <div class="confirm-delete-box">
      <h3>Delete Save</h3>
      <p>Remove "<strong>${title}</strong>" from your library?<br>This also removes it from all collections.</p>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="closeDeleteConfirm()">Cancel</button>
        <button class="modal-btn modal-btn-danger" onclick="executeSaveDelete('${saveId}')">Delete</button>
      </div>
    </div>
  </div>`;
}

function closeDeleteConfirm() {
  document.getElementById("deleteConfirmModal").style.display = "none";
}

async function executeSaveDelete(saveId) {
  closeDeleteConfirm();
  try {
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/library?id=${saveId}`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${accessToken}`, apikey: SUPABASE_ANON_KEY },
    });
    if (resp.ok) {
      showToast("Save deleted", "success");
      loadCollections();
      loadLibrary(document.getElementById("searchInput").value.trim());
    } else {
      const data = await resp.json();
      showToast(data.error || "Failed to delete", "error");
    }
  } catch (e) {
    showToast("Network error", "error");
  }
}

// ‚îÄ‚îÄ‚îÄ TOAST SYSTEM ‚îÄ‚îÄ‚îÄ
function showToast(message, type = "success", duration = 3000) {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  const icon = type === "success" ? "‚úì" : "‚úï";
  toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.animation = "toastOut 0.3s ease-in forwards";
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// Fetch feature flags and config from server
async function fetchConfig() {
  try {
    const res = await fetch(`${SUPABASE_URL}/functions/v1/config`, {
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "x-platform": "web",
        "x-app-version": WEB_APP_VERSION,
      }
    });
    if (res.ok) {
      const config = await res.json();
      featureFlags = config.features || {};
      if (config.force_update) {
        document.body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;text-align:center;padding:40px;"><div><div style="font-size:48px;margin-bottom:16px;">&#x2B06;&#xFE0F;</div><h2>Update Required</h2><p style="color:var(--text-muted);margin-top:8px;">Please refresh to get the latest version of dopo.</p><button onclick="location.reload()" style="margin-top:16px;padding:10px 24px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;">Refresh</button></div></div>`;
        return false;
      }
      console.log("[Config] Feature flags loaded:", Object.keys(featureFlags).length, "flags");
    }
  } catch (e) {
    console.warn("[Config] Failed to fetch config:", e);
  }
  return true;
}

// Check if a feature flag is enabled for web
function isFeatureEnabled(key) {
  return featureFlags[key]?.enabled ?? false;
}

(async function init() {
  // Fetch config first (feature flags, design tokens, version check)
  const configOk = await fetchConfig();
  if (!configOk) return;

  // Check if this is a shared collection view first
  if (await checkSharedView()) return;
  document.querySelector('[data-filter="all"]').classList.add("active");
  if (await checkExistingSession()) showApp();
})();
</script>
</body>
</html>
